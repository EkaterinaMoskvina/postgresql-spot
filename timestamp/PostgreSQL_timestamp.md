## Timestamp
### Подходы к хранению времени в БД
1. Если вам нужно хранить время только что произошедшего события, текущее время, по факту определённого действия, храните его в UTC. Это могут быть записи в логах, время регистрации пользователя, совершения заказа или отправки письма;
2. Если время не привязано к пользователю или его часовому поясу, храните его в UTC. Это может быть, например, время следующего солнечного затмения;
3. Если вам нужно хранить время в прошлом или в будущем, сохраняйте локальное время пользователя, а рядом сохраняйте его таймзону. А ещё лучше, так, чтобы наверняка, сохраняйте географическое положение пользователя. Если нужно делать выборки по этому времени, сохраняйте рядом время в UTC, и обновляйте это время при изменении информации о часовом поясе;
4. Если вам нужно совершенно точно знать время для любой даты для заданного географического положения (например, для астрономических расчётов) — храните точные координаты пользователя, но не его часовой пояс. Впрочем, если перед вами стоит такая задача, то вы и так знаете, как делать правильно.  

Подробнее о проблемах хранения времени можно прочитать в статье - [работа с таймзонами](https://habr.com/company/mailru/blog/242645/)  


### Timestamp в PostgreSQL
**Timestamp** – содержит дату и время;  
**Timestamptz** – содержит дату, время и часовой пояс. Значения в timestamptz указаны в формате UTC.

Типы timestamp и timestamptz занимают одинаковое место на диске.

Timestamptz полезно использовать, если с приложением можно работать из разных часовых зон или если в стране есть перевод времени на зимнее/летнее.

Если часовой пояс в запросе к полю timestamptz не указан, PostgreSQL использует заранее сконфигурированное время. Конфигурировать время можно разными способами:  
- параметр timezone в postgresql.conf используется для того, чтобы указать в каком часовом поясе находится сервер. Если другие параметры не заданы, будет использоваться он;
- ```ALTER DATABASE foo SET timezone = 'Europe/Moscow';``` используется на уровне базы данных;
- ```ALTER USER u_foo SET timezone = 'Europe/Moscow';``` используется на уровне пользователя;
- ```SET timezone = 'Europe/Moscow'``` используется на уровне сессии.

### Примеры
В примере ниже показывается изменение вывода функции now() при изменении часового пояса на уровне сессии:
```sql
show timezone;
┌──────────┐
│ TimeZone │
├──────────┤
│ UTC      │
└──────────┘
SELECT now();
┌───────────────────────────────┐
│              now              │
├───────────────────────────────┤
│ 2018-06-02 09:54:00.469394+00 │
└───────────────────────────────┘
SET timezone = 'Europe/Moscow';
SELECT now();
┌───────────────────────────────┐
│              now              │
├───────────────────────────────┤
│ 2018-06-02 12:54:17.119815+03 │
└───────────────────────────────┘
```

В данном примере отобразится сколько времени было в Москве, когда в LA было 20 часов (Москва опережает LA на 10 часов). Сперва timestamp в часовом поясе LA сконвертировался в UTC, затем сконвертирован в часовой пояс текущей сессии:
```sql
show timezone;
┌───────────────┐
│   TimeZone    │
├───────────────┤
│ Europe/Moscow │
└───────────────┘
SELECT '2018-06-02 20:00:00-07'::timestamptz;
┌────────────────────────┐
│      timestamptz       │
├────────────────────────┤
│ 2018-06-03 06:00:00+03 │
└────────────────────────┘
```

Можно посмотреть время и по другому:
```sql
-- Сколько было времени в LA, когда в Москве было 20 вечера
SELECT '2018-06-02 20:00:00'::timestamptz at time zone 'America/Los_Angeles';
┌─────────────────────┐
│      timezone       │
├─────────────────────┤
│ 2018-06-02 10:00:00 │
└─────────────────────┘
-- OR
SELECT timezone('America/Los_Angeles', '2018-06-02 20:00:00'::timestamptz);
┌─────────────────────┐
│      timezone       │
├─────────────────────┤
│ 2018-06-02 10:00:00 │
└─────────────────────┘
-- Сколько было времени в Москве, когда в LA было 20 вечера
SELECT '2018-06-02 20:00:00'::timestamp at time zone 'America/Los_Angeles';
┌────────────────────────┐
│        timezone        │
├────────────────────────┤
│ 2018-06-03 06:00:00+03 │
└────────────────────────┘
-- OR
SELECT timezone('America/Los_Angeles', '2018-06-02 20:00:00'::timestamp);
┌────────────────────────┐
│        timezone        │
├────────────────────────┤
│ 2018-06-03 06:00:00+03 │
└────────────────────────┘
```

В данном примере выведем время с точностью до секунд:
```sql
SELECT now()::timestamptz(0);
┌────────────────────────┐
│          now           │
├────────────────────────┤
│ 2018-06-02 13:29:03+03 │
└────────────────────────┘
-- OR
SELECT to_char(now(), 'YYYY-MM-DD HH24:MI:SS TZ');
┌─────────────────────────┐
│         to_char         │
├─────────────────────────┤
│ 2018-06-02 13:30:40 MSK │
└─────────────────────────┘
-- OR
SELECT date_trunc('second', now());
┌────────────────────────┐
│       date_trunc       │
├────────────────────────┤
│ 2018-06-02 13:31:01+03 │
└────────────────────────┘
```
