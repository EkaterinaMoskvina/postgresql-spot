## Схемы и привилегии
### Схемы
Схемы в некоторым смысле подобны каталогам в операционной системе, но они не могут быть вложенными.  
Схема по сути представляет собой пространство имён: она содержит именованные объекты (таблицы, типы данных, функции и операторы), имена которых могут совпадать с именами других объектов, существующих в других схемах. Для обращения к объекту нужно либо «дополнить» его имя именем схемы в виде префикса, либо установить путь поиска, включающий требуемую схему. Команда CREATE, в которой указывается неполное имя объекта, создаёт объект в текущей схеме (схеме, стоящей первой в пути поиска; узнать её позволяет функция current_schema).  

Есть несколько возможных объяснений, для чего стоит применять схемы:
- Чтобы одну базу данных могли использовать несколько пользователей, независимо друг от друга.
- Чтобы объединить объекты базы данных в логические группы для облегчения управления ими.
- Чтобы в одной базе сосуществовали разные приложения, и при этом не возникало конфликтов имён.

Более подробно про варианты применения схем будет описано ниже (в главе **Шаблоны использования**).

#### Создание и удаление схемы
Для создания схемы используется команда CREATE SCHEMA. При этом вы определяете имя схемы по своему выбору, например так:
```sql
CREATE SCHEMA myschema;
```
Чтобы удалить пустую схему (не содержащую объектов), выполните:
```sql
DROP SCHEMA myschema;
```
Удалить схему со всеми содержащимися в ней объектами можно так:
```sql
DROP SCHEMA myschema CASCADE;
```

#### Обращение к объектам в схеме
Чтобы создать объекты в схеме или обратиться к ним, указывайте полное имя, состоящее из имён схемы и объекта, разделённых точкой: `схема.таблица`

#### Путь поиска схем (search_path)
Чтобы каждый раз не указывать схему явно, можно задать путь поиска (`search_path`). Первая существующая схема в пути поиска называется текущей. Эта схема будет использоваться не только при поиске, но и при создании объектов.  

Если объекты отсутствуют в первой схеме, поиск продолжается во всех остальных схемах из `search_path`, пока объект не будет найден.  

Если объект не существует или находится в схеме, не добавленной в `search_path`, мы получим ошибку.

*Примечание: Путь поиска можно изменить во время выполнения следующей командой:*
```sql
SET search_path TO схема [, схема, ...]
```

#### Схема Public
Во всех базах данных по умолчанию есть схема public. Единственное, что отличает схему `public` от других, это то, что она существует по умолчанию, хотя её так же можно удалить. По умолчанию, она идет второй схемой в `search_path`:  
```sql
show search_path;
┌─────────────────┐
│   search_path   │
├─────────────────┤
│ "$user", public │
└─────────────────┘
```
Если `search_path` не был изменен и в базе данных нет схемы, совпадающей с именем текущего пользователя, все объекты без явного указания схемы будут создаваться в `public`.

#### Схема системного каталога
В дополнение к схеме `public` и схемам, создаваемым пользователями, любая база данных содержит схему `pg_catalog`, в которой находятся системные таблицы и все встроенные типы данных, функции и операторы. `pg_catalog` **фактически всегда является частью пути поиска**. Если даже эта схема не добавлена в путь явно, она неявно просматривается до всех схем, указанных в пути. Так обеспечивается доступность встроенных имён при любых условиях. Однако вы можете явным образом поместить pg_catalog в конец пути поиска, если вам нужно, чтобы пользовательские имена переопределяли встроенные.

Так как имена системных таблиц начинаются с `pg_`, такие имена лучше не использовать во избежание конфликта имён, возможного при появлении в будущем системной таблицы с тем же именем, что и ваша. (С путём поиска по умолчанию неполная ссылка будет воспринята как обращение к системной таблице.) Системные таблицы будут и дальше содержать в имени приставку `pg_`, так что они не будут конфликтовать с неполными именами пользовательских таблиц, если пользователи со своей стороны не будут использовать приставку `pg_`.

#### Функции получения информации о схеме
- Функция current_schema возвращает имя схемы, которая стоит первой в пути поиска (или NULL, если путь поиска пуст). Эта схема будет задействована при создании таблиц или других именованных объектов, если целевая схема не указана явно.
```sql
select current_schema;
┌────────────────┐
│ current_schema │
├────────────────┤
│ public         │
└────────────────┘
```
- Функция current_schemas(boolean) возвращает массив имён всех схем, находящихся в пути поиска. Её логический параметр определяет, будут ли включаться в результат неявно добавляемые в путь поиска системные схемы, такие как pg_catalog.
```sql
select current_schemas(true);
┌─────────────────────┐
│   current_schemas   │
├─────────────────────┤
│ {pg_catalog,public} │
└─────────────────────┘
```

### Привелегии
По умолчанию пользователь не может обращаться к объектам в чужих схемах. Чтобы изменить это, владелец схемы должен дать пользователю право `USAGE` для данной схемы. Чтобы пользователи могли использовать объекты схемы, может понадобиться назначить дополнительные права на уровне объектов.

Пользователю также можно разрешить создавать объекты в схеме, не принадлежащей ему. Для этого ему нужно дать право `CREATE` в требуемой схеме. Заметьте, что по умолчанию все имеют права `CREATE` и `USAGE` в схеме `public`. Благодаря этому все пользователи могут подключаться к заданной базе данных и создавать объекты в её схеме `public`.

#### Установка владельца схемы
Часто бывает нужно создать схему, владельцем которой будет другой пользователь (это один из способов ограничения пользователей пространствами имён). Сделать это можно так:  
```sql
CREATE SCHEMA имя_схемы AUTHORIZATION имя_пользователя;
```
Вы даже можете опустить имя схемы, в этом случае именем схемы станет имя пользователя.  
Схемы с именами, начинающимися с pg_, являются системными; пользователям не разрешено использовать такие имена.

### Шаблоны использования схем
1. Ограничить обычных пользователей личными схемами. Для реализации этого подхода выполните
`REVOKE CREATE ON SCHEMA public FROM PUBLIC` (первое слово `public` обозначает схему, а второе означает «каждый пользователь». В первом случае это идентификатор, а во втором — ключевое слово) и создайте для каждого пользователя схему с его именем. Если затрагиваемые пользователи подключались к базе ранее, проведите аудит схемы на предмет наличия таких же имён, как в схеме `pg_catalog`. Вспомните, что путь поиска по умолчанию начинается со значения `$user`, которое разрешается в имя пользователя. Таким образом, если у всех пользователей будет отдельная схема, они по умолчанию будут обращаться к собственным схемам.

2. Удалить схему `public` из пути поиска по умолчанию для каждого пользователя, с помощью команды `ALTER ROLE пользователь SET search_path = "$user"`. Все сохранят возможность создавать объекты в общедоступной схеме, но обращаться к ним будут только по полным именам. Пользователь, имеющий право `CREATEROLE`, сможет отменить присвоение этого пути и выполнять произвольные запросы от имени пользователей, полагающихся на расширенный путь. Если вы даёте пользователям право `CREATEROLE`, но не хотите, чтобы они стали практически суперпользователями, вам нужно использовать первый шаблон.

3. Удалить схему `public` из пути поиска (`search_path`) в `postgresql.conf`. Это будет иметь такое же влияние на пользователей, что и предыдущий шаблон. При этом такое же влияние, как обладатели права `CREATEROLE`, смогут оказывать и владельцы баз данных. Если вы даёте пользователям права `CREATEROLE`, `CREATEDB` или делаете их владельцами отдельных баз данных, но не хотите, чтобы они стали практически суперпользователями, вам нужно использовать первый шаблон.

4. Сохранить поведение по умолчанию. Все пользователи неявно обращаются к схеме `public`. Тем самым имитируется ситуация с полным отсутствием схем, что позволяет осуществить плавный переход из среды без схем. Однако при этом любой пользователь может выполнять произвольные запросы от имени любого пользователя, который не позаботится о своей защите специально. Этот шаблон подходит, только если в базе данных имеется всего один или несколько взаимно доверяющих пользователей.

При любом подходе, устанавливая совместно используемые приложения (таблицы, которые нужны всем, дополнительные функции сторонних разработчиков и т. д.), помещайте их в отдельные схемы. Не забудьте дать другим пользователям права для доступа к этим схемам. Тогда пользователи смогут обращаться к этим дополнительным объектам по полному имени или при желании добавят эти схемы в свои пути поиска.

### Продвинутое использование схем
TODO (версионирование схемами Zalando, Avito)
