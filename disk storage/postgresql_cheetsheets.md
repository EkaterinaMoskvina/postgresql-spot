## Физическое устройство данных PostgreSQL

#### Ссылки
[Физическое хранилище в PostgreSQL](http://rachbelaid.com/introduction-to-postgres-physical-storage/)

#### Термины
filenode - id, представляющий ссылку на таблицу или индекс  
page - 8кб сегмент информации в файле, хранящем табличные данные  
CTID - физическое расположение версии строки в таблице  

#### Базы данных
Данные хранятся в PGDATA. Для каждой БД в кластере создается отдельная директория в PGDATA/base по имени OID БД в pg_database. Файлы базы данных по умолчанию хранятся в этой директории.

Чтобы получить OID БД по имени, можно выполнить запрос:  
```sql
select oid, datname from pg_database;

oid   |   datname
-------+-------------
   1  | template1
12398 | template0
12403 | postgres
17447 | foo
```
Или можо воспользоваться пакетом oid2name в консоли:
```sh
$> oid2name
All databases:
    Oid  Database Name  Tablespace
----------------------------------
  17447            foo  pg_default
  12398      template0  pg_default
      1      template1  pg_default
```
Файлы служебных таблиц (например, pg_database) хранятся в директории PGDATA/global.

#### Таблицы
Каждая таблица хранится в отдельном файле. Эти файлы называются по именам соответствующих filenode. Чтобы определить filenode таблицы по ее имени, можно выполнить запрос

    select pg_relation_filepath('bar');
    pg_relation_filepath
    ----------------------
    base/17447/27741

или

    > oid2name -d foo -t bar

    From database "foo":
      Filenode  Table Name
    ----------------------
         27741         bar

Когда таблица превышает в размере 1 гигабайт, она разделяется на файлы по 1 гигабайту каждый. Имя первого файла будет совпадать с filenode таблицы, имя второго файла будет filenode.1, третьего filenode.2 и так далее.


#### Строки
##### Структура
![table_file.png](table_file.png)
![heap_file_page](heap_file_page.png)
Таблица хранится в виде массива страниц фиксированного размера (по умолчанию 8кб). Каждая страница внутри себя содержит коллекцию элементов (строк, хранящихся на странице). Заголовки страниц содержат метаданные, такие как начало свободного места, конец свободного места и тд. Элементы представляют собой массив указателей, ссылающихся на реальные строки (tupples).

##### CTID
CTID является указателем на элемент и содержит номер страницы и номер элемента в массиве элементов на этой странице. CTID является постоянным, пока запись не обновлена или удалена. Vacuum не меняет CTID (хорошо бы проверить).

##### TOAST
Одна строка всегда находится в пределах одной страницы (т.е. все поля строки находятся на одной странице и не могут продолжаться на другой странице). Но при этом сами значения в полях таблиы не ограничены размером 8кб. Это возможно благодаря тому, что большие значения обрабатываются TOAST(The Oversized-Attribute Storage Technique) механизмом.

Каждая таблица имеет отдельную TOAST таблицу (с именем pg _ toast_(filenode). Большие значения, не помещающиеся в одну страницу, разибиваются части по 2кб и хранятся по частям в  TOAST таблице.  

##### Доступ к данным
![data_access](data_access.png)
Допустим, файл таблицы содержит одну страницу и в ней записана только одна строка. В таком случае, при вставке новой строки она будет размещена последовательно после первой строки. При этом указатель pd_lower начнет ссылаться на следующий "line pointer" (указатель на строку, на картинке отмечен красным прямоугольником)и pd_upper начнет ссылаться на следующую строку (на картинке зеленый прямоугольник).

![data_read](data_read.png)
Самыми распространенными методами доступа к данным являются
- последовательный доступ;
- индексный b-tree доступ.

В первом случае, все строки во всех страницах будут последовательно считаны путем сканирования "line pointers" каждой страницы.

В случае индексного b-tree доступа, сперва будет найдена запись в индексе (состоящем из пар ключ (значение предиката)- значение (TID или другими словами ссылка на "line pointer")), затем по этой записи произведено обращение к нужной странице файла таблицы.


##### FSM (free space map)
![alt text](https://www.postgresql.org/message-id/attachment/23510/fsm-drawing.png)  
Каждая таблица имеет FSM файл ((filenode)_ fsm), который хранит информацию о свободном месте, доступном в таблице. Информация в этом файле обновляется такими операциями, как VACUUM и вообще говоря может быть не абсолютно точной. FSM показывает, какие элементы были удалены или обновлены и их место может быть повторно переиспользовано. Данные в FSM организованы в виде дерева (в листьях хранится число свободных элементов на странице), чтобы можно было быстро найти страницу с требуемым числом свободных элементов.

Полезно знать, что VACUUM перезаписывает страницы, содержащие мертвые строки так, чтобы не допустить фрагментацию свободного места на странице. Место, высвобожденное VACUUM, не возвращается в систему, а остается зарезервировано для последующей вставки элементов.

##### VM (visibility map)
![alt text](http://www.interdb.jp/pg/img/fig-6-02.png)  
Каждая таблица имеет VM файл ((filenode)_ vm) для хранения информации о страницах (в виде битовой карты), которые содержат только строки, видимые всем транзакциям.

VM оптимизирует работу VACUUM, помечая некоторые страницы "полностью видимыми" (проставлена единица в битовой карте). В такие страницы VACUUM не заходит при сканировании таблицы. Бит видимости проставляется при выполнении VACUUM и снимается при выполнении операций INSERT, UPDATE, DELETE.

Стоит отметить, что это не отменяет необходимость сканировать все индексы.

#### Источники
- Документация и обучающие статьи postgrespro.ru
- Материалы с сайта interdb.jp
